import React, { useState, useEffect } from 'react';
import { Calendar, Bell } from 'lucide-react';

// Components
import LoadingScreen from './components/LoadingScreen';
import UnifiedAuthScreen from './components/UnifiedAuthScreen';
import Header from './components/Header';
import SearchBar from './components/SearchBar';
import TabNavigation from './components/TabNavigation';
import EventCard from './components/EventCard';
import ReminderCard from './components/ReminderCard';
import EmptyState from './components/EmptyState';
import AddItemModal from './components/AddItemModal';
import SettingsModal from './components/SettingsModal';
import ImageUploadModal from './components/ImageUploadModal';
import SyncPanel from './components/SyncPanel';
import PWAInstallPrompt from './components/PWAInstallPrompt';
import { CardSkeleton } from './components/ui/Loader';
import { useToast } from './components/ui/Toast';

// Services
import { fetchCalendarEvents, syncCalendarToFirestore } from './services/googleCalendar';
import { extractEventsFromEmails, syncGmailEventsToFirestore } from './services/gmail';
import {
  requestNotificationPermission,
  registerServiceWorker,
  scheduleEventNotifications,
  checkAndSendNotifications,
} from './services/notifications';

// IMPORTANT: Replace this with YOUR Firebase config from Firebase Console
const FIREBASE_CONFIG = {
  apiKey: process.env.REACT_APP_FIREBASE_API_KEY,
  authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
  storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.REACT_APP_FIREBASE_APP_ID,
};

const FamilyHubPWA = () => {
  // Auth & Firebase State
  const [activeTab, setActiveTab] = useState('events');
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [firebaseInitialized, setFirebaseInitialized] = useState(false);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);

  // Data State
  const [familyMembers, setFamilyMembers] = useState([
    { id: 1, name: 'Parent', color: '#6366F1' },
    { id: 2, name: 'Child 1', color: '#22C55E' },
    { id: 3, name: 'Child 2', color: '#F59E0B' },
    { id: 4, name: 'Shared', color: '#A855F7' },
  ]);
  const [events, setEvents] = useState([]);
  const [reminders, setReminders] = useState([]);

  // Loading States
  const [dataLoading, setDataLoading] = useState(true);
  const [isSigningIn, setIsSigningIn] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [completingIds, setCompletingIds] = useState(new Set());
  const [deletingIds, setDeletingIds] = useState(new Set());
  const [isUploading, setIsUploading] = useState(false);

  // UI State
  const [showAddModal, setShowAddModal] = useState(false);
  const [showImageUpload, setShowImageUpload] = useState(false);
  const [showSettingsModal, setShowSettingsModal] = useState(false);
  const [showSyncPanel, setShowSyncPanel] = useState(false);
  const [selectedMember, setSelectedMember] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [editingMembers, setEditingMembers] = useState([]);

  // New Features State
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  const [googleAccessToken, setGoogleAccessToken] = useState(null);

  const [newEvent, setNewEvent] = useState({
    title: '',
    description: '',
    date: '',
    time: '',
    member: '',
    type: 'event',
    priority: 'medium',
  });

  const { showToast, ToastComponent } = useToast();

  // Helper: Load Script
  const loadScript = (src) => {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  };

  // Initialize Firebase
  useEffect(() => {
    const initFirebase = async () => {
      try {
        await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js');

        if (!window.firebase.apps.length) {
          window.firebase.initializeApp(FIREBASE_CONFIG);
        }

        const authInstance = window.firebase.auth();
        const dbInstance = window.firebase.firestore();

        setAuth(authInstance);
        setDb(dbInstance);
        setFirebaseInitialized(true);

        authInstance.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
          if (!user) {
            setDataLoading(false);
          }
        });
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showToast('Failed to initialize app. Please refresh.', 'error');
        setLoading(false);
      }
    };

    initFirebase();
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // Load Family Members
  useEffect(() => {
    if (!firebaseInitialized || !user || !db) return;

    const unsubscribe = db
      .collection('users')
      .doc(user.uid)
      .onSnapshot((doc) => {
        if (doc.exists && doc.data().familyMembers) {
          setFamilyMembers(doc.data().familyMembers);
        } else {
          // Initialize with default members
          const defaultMembers = [
            { id: 1, name: 'Parent', color: '#6366F1' },
            { id: 2, name: 'Child 1', color: '#22C55E' },
            { id: 3, name: 'Child 2', color: '#F59E0B' },
            { id: 4, name: 'Shared', color: '#A855F7' },
          ];
          setFamilyMembers(defaultMembers);
          db.collection('users')
            .doc(user.uid)
            .set({
              familyMembers: defaultMembers,
              createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
            });
        }
      });

    return () => unsubscribe();
  }, [firebaseInitialized, user, db]);

  // Load Events and Reminders
  useEffect(() => {
    if (!firebaseInitialized || !user || !db) return;

    setDataLoading(true);

    const unsubscribeEvents = db
      .collection('events')
      .where('userId', '==', user.uid)
      .orderBy('createdAt', 'desc')
      .onSnapshot((snapshot) => {
        const eventsData = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        setEvents(eventsData);
        setDataLoading(false);
      });

    const unsubscribeReminders = db
      .collection('reminders')
      .where('userId', '==', user.uid)
      .orderBy('createdAt', 'desc')
      .onSnapshot((snapshot) => {
        const remindersData = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        setReminders(remindersData);
      });

    return () => {
      unsubscribeEvents();
      unsubscribeReminders();
    };
  }, [firebaseInitialized, user, db]);

  // Handlers
  const handleGoogleSignIn = async () => {
    if (!auth) return;
    setIsSigningIn(true);
    try {
      const provider = new window.firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      showToast('Successfully signed in!', 'success');
    } catch (error) {
      console.error('Sign in error:', error);
      showToast('Sign in failed: ' + error.message, 'error');
    } finally {
      setIsSigningIn(false);
    }
  };

  const handleSignOut = async () => {
    if (!auth) return;
    try {
      await auth.signOut();
      showToast('Successfully signed out', 'info');
    } catch (error) {
      console.error('Sign out error:', error);
      showToast('Sign out failed: ' + error.message, 'error');
    }
  };

  const handleAddItem = async () => {
    if (!newEvent.title || !newEvent.member || !user || !db) return;

    setIsSubmitting(true);
    const item = {
      ...newEvent,
      userId: user.uid,
      createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
      completed: false,
    };

    try {
      if (newEvent.type === 'event') {
        await db.collection('events').add(item);
        showToast('Event added successfully!', 'success');
      } else {
        await db.collection('reminders').add(item);
        showToast('Reminder added successfully!', 'success');
      }

      setNewEvent({
        title: '',
        description: '',
        date: '',
        time: '',
        member: '',
        type: 'event',
        priority: 'medium',
      });
      setShowAddModal(false);
    } catch (error) {
      console.error('Error adding item:', error);
      showToast('Failed to add item: ' + error.message, 'error');
    } finally {
      setIsSubmitting(false);
    }
  };

  const toggleComplete = async (id, type) => {
    if (!db) return;

    setCompletingIds(prev => new Set(prev).add(id));

    try {
      const collection = type === 'event' ? 'events' : 'reminders';
      const docRef = db.collection(collection).doc(id);
      const doc = await docRef.get();

      if (doc.exists) {
        await docRef.update({
          completed: !doc.data().completed,
        });
      }
    } catch (error) {
      console.error('Error toggling complete:', error);
      showToast('Failed to update status', 'error');
    } finally {
      setCompletingIds(prev => {
        const newSet = new Set(prev);
        newSet.delete(id);
        return newSet;
      });
    }
  };

  const deleteItem = async (id, type) => {
    if (!db) return;
    if (!window.confirm('Are you sure you want to delete this item?')) return;

    setDeletingIds(prev => new Set(prev).add(id));

    try {
      const collection = type === 'event' ? 'events' : 'reminders';
      await db.collection(collection).doc(id).delete();
      showToast('Item deleted successfully', 'success');
    } catch (error) {
      console.error('Error deleting item:', error);
      showToast('Failed to delete item: ' + error.message, 'error');
    } finally {
      setDeletingIds(prev => {
        const newSet = new Set(prev);
        newSet.delete(id);
        return newSet;
      });
    }
  };

  const openSettings = () => {
    setEditingMembers([...familyMembers]);
    setShowSettingsModal(true);
  };

  const updateMemberName = (id, newName) => {
    setEditingMembers(editingMembers.map((m) => (m.id === id ? { ...m, name: newName } : m)));
  };

  const updateMemberColor = (id, newColor) => {
    setEditingMembers(editingMembers.map((m) => (m.id === id ? { ...m, color: newColor } : m)));
  };

  const addFamilyMember = () => {
    const newId = Math.max(...editingMembers.map((m) => m.id)) + 1;
    setEditingMembers([...editingMembers, { id: newId, name: `Member ${newId}`, color: '#6B7280' }]);
  };

  const removeFamilyMember = (id) => {
    if (editingMembers.length <= 1) {
      showToast('You must have at least one family member!', 'error');
      return;
    }
    setEditingMembers(editingMembers.filter((m) => m.id !== id));
  };

  const saveFamilyMembers = async () => {
    if (!user || !db) return;

    setIsSaving(true);
    try {
      await db
        .collection('users')
        .doc(user.uid)
        .set(
          {
            familyMembers: editingMembers,
            updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          },
          { merge: true }
        );

      setFamilyMembers(editingMembers);
      setShowSettingsModal(false);
      showToast('Family members updated successfully!', 'success');
    } catch (error) {
      console.error('Error saving family members:', error);
      showToast('Failed to save: ' + error.message, 'error');
    } finally {
      setIsSaving(false);
    }
  };

  const handleImageUpload = async (file) => {
    if (!file) return;

    setIsUploading(true);
    setShowImageUpload(false);

    try {
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      showToast('Extracting text from image...', 'info');

      const GOOGLE_VISION_API_KEY = process.env.REACT_APP_GOOGLE_VISION_API_KEY;
      const response = await fetch(
        `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            requests: [
              {
                image: { content: base64 },
                features: [{ type: 'TEXT_DETECTION' }],
              },
            ],
          }),
        }
      );

      const data = await response.json();

      if (data.responses && data.responses[0].textAnnotations) {
        const extractedText = data.responses[0].textAnnotations[0].description;
        const lines = extractedText.split('\n').filter((line) => line.trim());

        setNewEvent({
          title: lines[0] || '',
          description: lines.slice(1, 3).join(' ') || '',
          date: extractDate(extractedText) || '',
          time: extractTime(extractedText) || '',
          member: '',
          type: 'event',
          priority: 'medium',
        });

        setShowAddModal(true);
        showToast('Text extracted! Please review and select family member.', 'success');
      } else {
        showToast('No text found in the image', 'error');
      }
    } catch (error) {
      console.error('Vision API error:', error);
      showToast('Failed to extract text: ' + error.message, 'error');
    } finally {
      setIsUploading(false);
    }
  };

  const extractDate = (text) => {
    const dateRegex = /(\d{4}-\d{2}-\d{2}|\d{1,2}[/-]\d{1,2}[/-]\d{4}|\w{3,9}\s+\d{1,2},?\s+\d{4})/i;
    const match = text.match(dateRegex);
    if (match) {
      const date = new Date(match[0]);
      if (!isNaN(date)) return date.toISOString().split('T')[0];
    }
    return '';
  };

  const extractTime = (text) => {
    const timeRegex = /(\d{1,2}):(\d{2})\s*(am|pm)?/i;
    const match = text.match(timeRegex);
    if (match) {
      let hours = parseInt(match[1]);
      const minutes = match[2];
      const meridiem = match[3];

      if (meridiem && meridiem.toLowerCase() === 'pm' && hours < 12) {
        hours += 12;
      } else if (meridiem && meridiem.toLowerCase() === 'am' && hours === 12) {
        hours = 0;
      }

      return `${hours.toString().padStart(2, '0')}:${minutes}`;
    }
    return '';
  };

  const getMemberColor = (memberId) => {
    const member = familyMembers.find((m) => m.id === parseInt(memberId));
    return member ? member.color : '#6B7280';
  };

  const getMemberName = (memberId) => {
    const member = familyMembers.find((m) => m.id === parseInt(memberId));
    return member ? member.name : 'Unknown';
  };

  const filterItems = (items) => {
    let filtered = items;

    if (selectedMember) {
      filtered = filtered.filter((item) => item.member === selectedMember.toString());
    }

    if (searchTerm) {
      filtered = filtered.filter(
        (item) =>
          item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
          (item.description && item.description.toLowerCase().includes(searchTerm.toLowerCase()))
      );
    }

    return filtered.sort((a, b) => {
      const dateA = a.date ? new Date(a.date) : new Date(0);
      const dateB = b.date ? new Date(b.date) : new Date(0);
      return dateA - dateB;
    });
  };

  // Render Loading Screen
  if (loading) {
    return <LoadingScreen message="Initializing Family Hub..." />;
  }

  // Render Auth Screen
  if (!user) {
    return (
      <>
        <AuthScreen
          onSignIn={handleGoogleSignIn}
          firebaseInitialized={firebaseInitialized}
          isSigningIn={isSigningIn}
        />
        {ToastComponent}
      </>
    );
  }

  const filteredEvents = filterItems(events);
  const filteredReminders = filterItems(reminders);

  // Render Main App
  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
      <Header
        user={user}
        onSettingsClick={openSettings}
        onImageUploadClick={() => setShowImageUpload(true)}
        onAddClick={() => setShowAddModal(true)}
        onSignOut={handleSignOut}
      />

      <main className="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <SearchBar
          searchTerm={searchTerm}
          onSearchChange={setSearchTerm}
          selectedMember={selectedMember}
          onMemberSelect={setSelectedMember}
          familyMembers={familyMembers}
        />

        <TabNavigation
          activeTab={activeTab}
          onTabChange={setActiveTab}
          eventCount={filteredEvents.length}
          reminderCount={filteredReminders.length}
        />

        {/* Content */}
        {dataLoading ? (
          <div className="space-y-4">
            <CardSkeleton />
            <CardSkeleton />
            <CardSkeleton />
          </div>
        ) : (
          <div className="space-y-4">
            {activeTab === 'events' && (
              <>
                {filteredEvents.length === 0 ? (
                  <EmptyState
                    icon={Calendar}
                    title="No events yet"
                    description="Add your first event to get started!"
                  />
                ) : (
                  filteredEvents.map((event) => (
                    <EventCard
                      key={event.id}
                      event={event}
                      onToggleComplete={toggleComplete}
                      onDelete={deleteItem}
                      getMemberName={getMemberName}
                      getMemberColor={getMemberColor}
                      isCompleting={completingIds.has(event.id)}
                      isDeleting={deletingIds.has(event.id)}
                    />
                  ))
                )}
              </>
            )}

            {activeTab === 'reminders' && (
              <>
                {filteredReminders.length === 0 ? (
                  <EmptyState
                    icon={Bell}
                    title="No reminders yet"
                    description="Add your first reminder to get started!"
                  />
                ) : (
                  filteredReminders.map((reminder) => (
                    <ReminderCard
                      key={reminder.id}
                      reminder={reminder}
                      onToggleComplete={toggleComplete}
                      onDelete={deleteItem}
                      getMemberName={getMemberName}
                      getMemberColor={getMemberColor}
                      isCompleting={completingIds.has(reminder.id)}
                      isDeleting={deletingIds.has(reminder.id)}
                    />
                  ))
                )}
              </>
            )}
          </div>
        )}
      </main>

      {/* Modals */}
      <AddItemModal
        isOpen={showAddModal}
        onClose={() => setShowAddModal(false)}
        newEvent={newEvent}
        setNewEvent={setNewEvent}
        familyMembers={familyMembers}
        onSubmit={handleAddItem}
        isSubmitting={isSubmitting}
      />

      <SettingsModal
        isOpen={showSettingsModal}
        onClose={() => setShowSettingsModal(false)}
        editingMembers={editingMembers}
        onUpdateMemberName={updateMemberName}
        onUpdateMemberColor={updateMemberColor}
        onAddMember={addFamilyMember}
        onRemoveMember={removeFamilyMember}
        onSave={saveFamilyMembers}
        isSaving={isSaving}
      />

      <ImageUploadModal
        isOpen={showImageUpload}
        onClose={() => setShowImageUpload(false)}
        onUpload={handleImageUpload}
        isUploading={isUploading}
      />

      {ToastComponent}
    </div>
  );
};

export default FamilyHubPWA;
